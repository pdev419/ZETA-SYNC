<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ZETA-SYNC Security</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <div class="wrap">
      <header class="top">
        <div>
          <div class="brand">ZETA-SYNC</div>
          <div class="sub">Security (mTLS)</div>
        </div>
        <nav class="nav">
          <a href="/">Home</a>
          <a href="/nodes">Nodes</a>
          <a href="/events">Events</a>
          <a class="active" href="/security">Security</a>
        </nav>
      </header>

      <div class="grid2">
        <div class="card">
          <h2>Authority / CA Status</h2>
          <div class="kv">
            <div><span>TLS Enabled</span><b id="tlsEnabled">-</b></div>
            <div><span>Authority node</span><b id="isAuthority">-</b></div>
            <div><span>CA Initialized</span><b id="caInit">-</b></div>
            <div><span>CA Fingerprint</span><b class="mono" id="caFp">-</b></div>
          </div>

          <div class="row">
            <button id="btnInitCa" class="btn primary" onclick="caInit()">Init CA</button>
            <button class="btn" onclick="caShow()">Show CA cert</button>
            <button class="btn" onclick="bootstrapCreate()">Create bootstrap token</button>
          </div>

          <details class="adv">
            <summary>Advanced / Debug</summary>
            <pre id="caOut"></pre>
            <pre id="tokenOut"></pre>
          </details>
        </div>

        <div class="card">
          <h2>Provision this node</h2>
          <p class="muted">Enter Authority URL + token. No PEM copy/paste.</p>

          <div class="row">
            <input id="authorityUrl" placeholder="Authority URL (e.g. http://192.168.2.126:8080)" style="min-width: 380px; margin-bottom: 10px;" />
          </div>
          <div class="row">
            <input id="bootstrapToken" placeholder="Bootstrap token" style="min-width: 380px; margin-bottom: 10px;" />
          </div>

          <div class="row">
            <button class="btn primary" onclick="provisionThisNode()">Provision</button>
            <button class="btn warn" onclick="restartService()">Restart service</button>
          </div>

          <pre id="provisionOut" class="small"></pre>
        </div>
      </div>

      <div class="card">
        <div class="row spread">
          <div>
            <h2 style="margin:0">Pending nodes</h2>
            <div class="muted">Nodes appear here when TLS is enabled + allowlist required.</div>
          </div>
          <button class="btn" onclick="loadPending()">Refresh</button>
        </div>

        <div id="pendingList"></div>

        <details class="adv">
          <summary>Advanced / Debug</summary>
          <pre id="securityState"></pre>
        </details>
      </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
      async function refreshCaStatus(){
        const st = await fetch("/api/v1/security/ca/status").then(r=>r.json());
        document.getElementById("tlsEnabled").textContent = st.tls_enabled ? "YES" : "NO";
        document.getElementById("isAuthority").textContent = st.is_authority ? "YES" : "NO";
        document.getElementById("caInit").textContent = st.ca_initialized ? "YES" : "NO";
        document.getElementById("caFp").textContent = st.ca_fingerprint_sha256 ? st.ca_fingerprint_sha256.slice(0,16)+"â€¦" : "-";

        const btn = document.getElementById("btnInitCa");
        if(st.ca_initialized){ btn.disabled = true; btn.classList.add("disabled"); }
        else { btn.disabled = false; btn.classList.remove("disabled"); }
      }

      async function caInit() {
        const res = await apiCall("POST", "/mgmt/security/ca/init");
        document.getElementById("caOut").textContent = JSON.stringify(res, null, 2);
        refreshCaStatus();
      }

      async function caShow() {
        const res = await apiCall("GET", "/mgmt/security/ca/cert");
        document.getElementById("caOut").textContent = res.ca_cert_pem || JSON.stringify(res, null, 2);
      }

      async function bootstrapCreate() {
        const res = await apiCall("POST", "/mgmt/security/bootstrap/token/create");
        document.getElementById("tokenOut").textContent = "BOOTSTRAP TOKEN (share once):\n\n" + (res.token || JSON.stringify(res, null, 2));
      }

      async function provisionThisNode() {
        const authority = document.getElementById("authorityUrl").value.trim();
        const token = document.getElementById("bootstrapToken").value.trim();
        if (!authority) return alert("Enter Authority URL");
        if (!token) return alert("Enter Bootstrap token");

        const st = await fetch("/api/v1/cluster/status").then(r => r.json());
        const nodeId = st.node_id;
        if (!nodeId) return alert("Local node_id not found");

        const bundle = await authorityIssueBundle(authority, nodeId, token);
        await apiCall("POST", "/mgmt/security/local/install-bundle", bundle);

        document.getElementById("provisionOut").textContent =
          "Provision OK.\nNext: Restart service.\n\n" + JSON.stringify(bundle.meta || {}, null, 2);
      }

      async function restartService() {
        const res = await apiCall("POST", "/mgmt/system/restart");
        document.getElementById("provisionOut").textContent = JSON.stringify(res, null, 2);
      }

      function pendingRow(key, item) {
        const div = document.createElement("div");
        div.className = "pending";
        div.innerHTML = `
          <div class="row spread">
            <div>
              <b>${escapeHtml(item.node_id || "")}</b>
              <div class="muted small">peer: ${escapeHtml(item.peer || "")}</div>
            </div>
            <div class="row">
              <button class="btn primary approveBtn">Approve</button>
              <button class="btn denyBtn">Deny</button>
            </div>
          </div>
          <details class="adv">
            <summary>Advanced / Debug</summary>
            <pre>${escapeHtml(JSON.stringify(item, null, 2))}</pre>
          </details>
        `;

        div.querySelector(".approveBtn").onclick = async () => {
          const res = await apiCall("POST", "/mgmt/security/nodes/approve?node_id=" + encodeURIComponent(item.node_id) + "&pending_key=" + encodeURIComponent(key));
          alert("Approved: " + JSON.stringify(res));
          loadPending(); loadSecurityState();
        };
        div.querySelector(".denyBtn").onclick = async () => {
          const res = await apiCall("POST", "/mgmt/security/nodes/deny?pending_key=" + encodeURIComponent(key));
          alert("Denied: " + JSON.stringify(res));
          loadPending(); loadSecurityState();
        };

        return div;
      }

      async function loadPending() {
        const res = await apiCall("GET", "/mgmt/security/nodes/pending");
        const pending = res.pending || {};
        const box = document.getElementById("pendingList");
        box.innerHTML = "";
        const keys = Object.keys(pending);
        if (!keys.length) { box.innerHTML = `<div class="muted">No pending nodes.</div>`; return; }
        keys.forEach(k => box.appendChild(pendingRow(k, pending[k])));
      }

      async function loadSecurityState() {
        const res = await apiCall("GET", "/mgmt/security/state");
        document.getElementById("securityState").textContent = JSON.stringify(res, null, 2);
      }

      refreshCaStatus();
      loadPending();
      loadSecurityState();
      setInterval(loadPending, 3000);
      setInterval(refreshCaStatus, 3000);
    </script>
  </body>
</html>
