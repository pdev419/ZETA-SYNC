<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Security - ZETA-SYNC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--border:#1f2937;--text:#e5e7eb;--muted:#94a3b8;
      --blue:#2563eb;--gray:#334155;--red:#dc2626;--green:#22c55e;--amber:#fbbf24;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(15,23,42,.9);backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border); padding:14px 18px; display:flex; align-items:center; gap:14px;}
    nav a{color:var(--muted); text-decoration:none; margin-right:10px; font-size:14px}
    nav a:hover{color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .title{font-weight:800}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:10px 12px;color:white;cursor:pointer;font-weight:800}
    button.primary{background:var(--blue)}
    button.secondary{background:var(--gray)}
    button.danger{background:var(--red)}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
    pre{margin:0;background:#0b1220;border:1px solid var(--border);padding:12px;border-radius:12px;overflow:auto;font-family:var(--mono);font-size:12px;color:#cbd5e1}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:12px;color:var(--muted);font-weight:800}
    td{font-size:13px}
    .mono{font-family:var(--mono)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--amber)}
    .dot.ok{background:var(--green)} .dot.warn{background:var(--amber)}
    .right{margin-left:auto}
  </style>
</head>
<body>
<header>
  <div style="font-weight:800;">ZETA-SYNC</div>
  <nav>
    <a href="/">Home</a>
    <a href="/nodes">Nodes</a>
    <a href="/events">Events</a>
    <a href="/security">Security</a>
  </nav>
  <div class="right" id="tlsPill"></div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card" style="grid-column: span 5;">
      <div class="title">Admin Login</div>
      <div class="sub">Used for management actions</div>
      <div style="height:10px;"></div>
      <div class="grid">
        <div style="grid-column: span 6;"><input id="adminUser" placeholder="ADMIN_USER" /></div>
        <div style="grid-column: span 6;"><input id="adminPass" placeholder="ADMIN_PASS" type="password" /></div>
      </div>
      <div style="height:10px;"></div>
      <div class="row">
        <button class="secondary" onclick="refreshAll()">Refresh</button>
        <button class="primary" onclick="createToken()">Create Token</button>
      </div>
      <div style="height:10px;"></div>
      <pre id="result">{}</pre>
    </div>

    <div class="card" style="grid-column: span 7;">
      <div class="title">Join (No cert copy/paste)</div>
      <div class="sub">Paste only: remote URL + token → Pull + Install → Restart</div>
      <div style="height:10px;"></div>
      <div class="grid">
        <div style="grid-column: span 8;">
          <input id="remoteUrl" placeholder="Remote URL (e.g. http://192.168.2.126:8080)" />
        </div>
        <div style="grid-column: span 4;">
          <input id="token" placeholder="token" />
        </div>
      </div>
      <div style="height:10px;"></div>
      <div class="row">
        <button class="primary" onclick="pullInstall()">Pull + Install</button>
        <button class="danger" onclick="restartService()">Restart (PM2)</button>
      </div>
      <div style="height:10px;"></div>
      <div class="sub">After restart, trigger connection (nodes will appear in Pending on the cluster).</div>
    </div>

    <div class="card" style="grid-column: span 12;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="title">Pending</div>
          <div class="sub">Approve join requests (allowlist)</div>
        </div>
        <button class="secondary" onclick="loadPending()">Refresh Pending</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>pending_key</th>
            <th>node_id</th>
            <th>peer</th>
            <th>last_seen</th>
            <th>action</th>
          </tr>
        </thead>
        <tbody id="pendingBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  async function apiGet(url){
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error(url+" -> "+r.status);
    return await r.json();
  }

  async function mgmtGet(url){
    const r = await fetch(url,{cache:"no-store"});
    const t = await r.text();
    try { return JSON.parse(t); } catch { return {status:r.status, raw:t}; }
  }
  async function mgmtPost(url, body){
    const r = await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body||{})});
    const t = await r.text();
    try { return JSON.parse(t); } catch { return {status:r.status, raw:t}; }
  }

  function setTls(on){
    $("tlsPill").innerHTML = `<span class="pill"><span class="dot ${on?"ok":"warn"}"></span><span>TLS ${on?"ENABLED":"DISABLED"}</span></span>`;
  }

  function fmtTs(ts){
    if(!ts) return "-";
    return new Date(ts*1000).toLocaleString();
  }

  async function refreshAll(){
    try{
      const h = await apiGet("/api/v1/health");
      setTls(!!h.tls_enabled);
      await loadPending();
    } catch(e){
      $("result").textContent = JSON.stringify({ok:false,error:String(e)},null,2);
    }
  }

  async function createToken(){
    const out = await mgmtPost("/mgmt/security/bootstrap/token/create");
    if(out.token) $("token").value = out.token;
    $("result").textContent = JSON.stringify(out,null,2);
  }

  async function pullInstall(){
    const base = ($("remoteUrl").value||"").trim().replace(/\/+$/,"");
    const token = ($("token").value||"").trim();
    if(!base||!token){ $("result").textContent = JSON.stringify({ok:false,error:"remoteUrl + token required"},null,2); return; }

    // local node_id
    const st = await apiGet("/api/v1/cluster/status");
    const nodeId = st.node_id;

    // pull from remote (no auth on remote issue endpoint)
    const r = await fetch(base+"/mgmt/security/bootstrap/issue",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({node_id:nodeId, token})
    });
    const txt = await r.text();
    let bundle=null;
    try{ bundle=JSON.parse(txt);}catch{ bundle={raw:txt,status:r.status}; }
    if(!r.ok){ $("result").textContent = JSON.stringify({ok:false,step:"remote issue failed",bundle},null,2); return; }

    // install locally (admin)
    const out = await mgmtPost("/mgmt/security/local/install-bundle", bundle);
    $("result").textContent = JSON.stringify({ok:true,installed:out,meta:bundle.meta},null,2);
  }

  async function restartService(){
    const out = await mgmtPost("/mgmt/system/restart");
    $("result").textContent = JSON.stringify(out,null,2);
  }

  async function loadPending(){
    const data = await mgmtGet("/mgmt/security/nodes/pending");
    const pending = data.pending || {};
    const keys = Object.keys(pending);

    const body = $("pendingBody");
    body.innerHTML = "";

    if(!keys.length){
      body.insertAdjacentHTML("beforeend", `<tr><td colspan="5" class="mono">No pending nodes</td></tr>`);
      return;
    }

    for(const k of keys){
      const p = pending[k] || {};
      const nodeId = p.node_id || "-";
      body.insertAdjacentHTML("beforeend", `
        <tr>
          <td class="mono">${k}</td>
          <td class="mono">${nodeId}</td>
          <td class="mono">${p.peer || "-"}</td>
          <td class="mono">${fmtTs(p.last_seen)}</td>
          <td class="row">
            <button class="primary" onclick="approve('${nodeId}','${k}')">Approve</button>
            <button class="danger" onclick="deny('${k}')">Deny</button>
          </td>
        </tr>
      `);
    }
  }

  async function approve(nodeId, pendingKey){
    const out = await mgmtPost("/mgmt/security/nodes/approve", {node_id:nodeId, pending_key:pendingKey});
    $("result").textContent = JSON.stringify(out,null,2);
    await loadPending();
  }
  async function deny(pendingKey){
    const out = await mgmtPost("/mgmt/security/nodes/deny", {pending_key:pendingKey, reason:"denied_in_ui"});
    $("result").textContent = JSON.stringify(out,null,2);
    await loadPending();
  }

  refreshAll();
  setInterval(loadPending, 3000);
</script>
</body>
</html>
