<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ZETA-SYNC Security (M3)</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <div class="wrap">
      <h1>Security (M3) â€” UI-only mTLS</h1>

      <div class="nav">
        <a href="/">Home</a>
        <a href="/nodes">Nodes</a>
        <a href="/events">Events</a>
        <a href="/security">Security (M3)</a>
      </div>

      <div class="card">
        <h2>1) Cluster CA (Authority node)</h2>
        <p>Pick ONE node as Authority. Initialize CA and create a bootstrap token.</p>
        <div class="row">
          <button onclick="caInit()">Init CA</button>
          <button onclick="caShow()">Show CA cert</button>
          <button onclick="bootstrapCreate()">Create Bootstrap Token</button>
        </div>
        <pre id="ca"></pre>
        <pre id="token"></pre>
      </div>

      <div class="card">
        <h2>2) Provision THIS node (no copy/paste PEM)</h2>
        <p>On a new node: enter Authority URL + Token and click Provision.</p>
        <div class="row">
          <input id="authorityUrl" placeholder="Authority URL (e.g. http://192.168.2.126:8080)" style="min-width:420px;" />
          <input id="bootstrapToken" placeholder="Bootstrap token" style="min-width:320px;" />
        </div>
        <div class="row">
          <button onclick="provisionThisNode()">Provision this node</button>
          <button onclick="restartService()">Restart service</button>
        </div>
        <pre id="provisionOut"></pre>
      </div>

      <div class="card">
        <h2>3) Pending nodes (Approve/Deny)</h2>
        <p>After provisioning + restart, nodes will appear as Pending until approved (allowlist).</p>
        <div class="row">
          <button onclick="loadPending()">Refresh pending</button>
        </div>
        <div id="pendingList"></div>
      </div>

      <div class="card">
        <h2>Allowlist / Blocklist</h2>
        <div class="row">
          <button onclick="loadSecurityState()">Refresh</button>
        </div>
        <pre id="state"></pre>

        <h3>Block node</h3>
        <div class="row">
          <input id="blockNodeId" placeholder="node-id to block" style="min-width:260px;" />
          <input id="blockReason" placeholder="reason" style="min-width:260px;" />
          <button onclick="blockNode()">Block</button>
        </div>
        <pre id="blockOut"></pre>
      </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
      async function caInit() {
        const res = await apiCall("POST", "/mgmt/security/ca/init");
        document.getElementById("ca").textContent = JSON.stringify(res, null, 2);
      }
      async function caShow() {
        const res = await apiCall("GET", "/mgmt/security/ca/cert");
        document.getElementById("ca").textContent = res.ca_cert_pem || JSON.stringify(res, null, 2);
      }
      async function bootstrapCreate() {
        const res = await apiCall("POST", "/mgmt/security/bootstrap/token/create");
        document.getElementById("token").textContent =
          "BOOTSTRAP TOKEN (share to other nodes, show once):\n\n" + (res.token || JSON.stringify(res, null, 2));
      }

      async function provisionThisNode() {
        const authority = document.getElementById("authorityUrl").value.trim();
        const token = document.getElementById("bootstrapToken").value.trim();
        if (!authority) return alert("Enter Authority URL");
        if (!token) return alert("Enter Bootstrap token");

        // get local node_id automatically
        const st = await fetch("/api/v1/cluster/status").then(r => r.json());
        const nodeId = st.node_id;
        if (!nodeId) return alert("Local node_id not found");

        // 1) Ask authority to issue bundle for this node_id
        const bundle = await authorityIssueBundle(authority, nodeId, token);

        // 2) Install bundle locally (writes files to data/state/tls/)
        const installed = await apiCall("POST", "/mgmt/security/local/install-bundle", bundle);

        document.getElementById("provisionOut").textContent =
          "Provision OK.\n\nNext: click 'Restart service'.\n\n" + JSON.stringify({ bundle_meta: bundle.meta, installed }, null, 2);
      }

      async function restartService() {
        const res = await apiCall("POST", "/mgmt/system/restart");
        document.getElementById("provisionOut").textContent = "Restart requested.\n" + JSON.stringify(res, null, 2);
      }

      function pendingRow(key, item) {
        const div = document.createElement("div");
        div.className = "pending";
        div.innerHTML = `
          <div><b>Key:</b> ${escapeHtml(key)}</div>
          <div><b>Node:</b> ${escapeHtml(item.node_id || "")}</div>
          <div><b>Peer:</b> ${escapeHtml(item.peer || "")}</div>
          <div class="row">
            <input class="approveId" placeholder="approve as node_id" value="${escapeHtml(item.node_id || "")}" />
            <button class="approveBtn">Approve</button>
            <button class="denyBtn">Deny</button>
          </div>
          <pre>${escapeHtml(JSON.stringify(item, null, 2))}</pre>
        `;
        div.querySelector(".approveBtn").onclick = async () => {
          const approveId = div.querySelector(".approveId").value.trim();
          if (!approveId) return alert("Enter approve node_id");
          const res = await apiCall("POST", "/mgmt/security/nodes/approve?node_id=" + encodeURIComponent(approveId) + "&pending_key=" + encodeURIComponent(key));
          alert("Approved: " + JSON.stringify(res));
          loadPending(); loadSecurityState();
        };
        div.querySelector(".denyBtn").onclick = async () => {
          const res = await apiCall("POST", "/mgmt/security/nodes/deny?pending_key=" + encodeURIComponent(key));
          alert("Denied: " + JSON.stringify(res));
          loadPending();
        };
        return div;
      }

      async function loadPending() {
        const res = await apiCall("GET", "/mgmt/security/nodes/pending");
        const pending = res.pending || {};
        const box = document.getElementById("pendingList");
        box.innerHTML = "";
        const keys = Object.keys(pending);
        if (!keys.length) { box.textContent = "No pending nodes."; return; }
        keys.forEach(k => box.appendChild(pendingRow(k, pending[k])));
      }

      async function loadSecurityState() {
        const res = await apiCall("GET", "/mgmt/security/state");
        document.getElementById("state").textContent = JSON.stringify(res, null, 2);
      }

      async function blockNode() {
        const nodeId = document.getElementById("blockNodeId").value.trim();
        const reason = document.getElementById("blockReason").value.trim() || "revoked";
        if (!nodeId) return alert("Enter node_id");
        const res = await apiCall("POST", "/mgmt/security/nodes/block?node_id=" + encodeURIComponent(nodeId) + "&reason=" + encodeURIComponent(reason));
        document.getElementById("blockOut").textContent = JSON.stringify(res, null, 2);
        loadSecurityState();
      }

      loadPending();
      loadSecurityState();
    </script>
  </body>
</html>
