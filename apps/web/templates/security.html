<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ZETA-SYNC Security</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>

  <body>
    <div class="wrap">
      <h1>Security</h1>

      <div class="nav">
        <a href="/">Home</a>
        <a href="/nodes">Nodes</a>
        <a href="/events">Events</a>
        <a href="/security">Security</a>
      </div>

      <div id="topStatus" class="row"></div>

      <div class="card">
        <div class="card-head">
          <div>
            <h2>0) Status</h2>
            <div class="muted">Check TLS state and local identity.</div>
          </div>
          <div class="row">
            <button class="smallbtn" onclick="refreshStatus()">Refresh</button>
            <button class="smallbtn btn-primary" onclick="restartService()">Restart service</button>
          </div>
        </div>
        <div class="grid2">
          <div>
            <div class="muted2">Local</div>
            <pre id="localInfo">loading…</pre>
          </div>
          <div>
            <div class="muted2">TLS</div>
            <pre id="tlsInfo">loading…</pre>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <h2>1) Authority node (CA)</h2>
            <div class="muted">Do this on ONE node only.</div>
          </div>
          <div class="row">
            <button class="smallbtn btn-primary" onclick="caInit()">Init CA + Self Identity</button>
            <button class="smallbtn" onclick="caShow()">Show CA cert</button>
            <button class="smallbtn" onclick="bootstrapCreate()">Create Bootstrap Token</button>
            <button class="smallbtn btn-ghost" onclick="copyTextFromEl('token')">Copy token</button>
          </div>
        </div>
        <pre id="ca"></pre>
        <pre id="token"></pre>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <h2>2) Provision THIS node</h2>
            <div class="muted">No copy/paste PEM. Just Authority URL + Token.</div>
          </div>
          <div class="row">
            <button class="smallbtn" onclick="provisionThisNode()">Provision this node</button>
            <button class="smallbtn btn-primary" onclick="restartService()">Restart service</button>
          </div>
        </div>

        <div class="row">
          <input id="authorityUrl" placeholder="Authority URL (e.g. http://192.168.2.126:8080)" style="min-width:420px;" />
          <input id="bootstrapToken" placeholder="Bootstrap token" style="min-width:320px;" />
        </div>

        <pre id="provisionOut"></pre>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <h2>3) Pending nodes</h2>
            <div class="muted">Approve nodes to allow them to join.</div>
          </div>
          <div class="row">
            <button class="smallbtn" onclick="loadPending()">Refresh pending</button>
            <button class="smallbtn" onclick="loadSecurityState()">Refresh allow/block</button>
          </div>
        </div>
        <div id="pendingList"></div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <h2>4) Allowlist / Blocklist</h2>
            <div class="muted">View current security state and revoke nodes.</div>
          </div>
          <div class="row">
            <button class="smallbtn" onclick="loadSecurityState()">Refresh</button>
            <button class="smallbtn btn-ghost" onclick="copyTextFromEl('state')">Copy JSON</button>
          </div>
        </div>

        <pre id="state"></pre>

        <h3>Block node</h3>
        <div class="row">
          <input id="blockNodeId" placeholder="node-id to block" style="min-width:260px;" />
          <input id="blockReason" placeholder="reason (optional)" style="min-width:260px;" />
          <button class="btn-danger" onclick="blockNode()">Block</button>
        </div>
        <pre id="blockOut"></pre>
      </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
      async function topStatus(){
        const box = document.getElementById("topStatus");
        try{
          const st = await fetch("/api/v1/cluster/status",{cache:"no-store"}).then(r=>r.json());
          const h = await fetch("/api/v1/health",{cache:"no-store"}).then(r=>r.json());
          box.innerHTML =
            pillHtml(h.tls_enabled ? "TLS enabled" : "TLS disabled", h.tls_enabled ? "ok" : "warn") +
            ` ${pillHtml(st.node_id || "node", "warn")}` +
            ` ${pillHtml(st.advertise_addr || "advertise", "warn")}`;
        }catch(e){
          box.innerHTML = pillHtml("status error", "bad");
        }
      }

      async function refreshStatus(){
        await topStatus();
        const st = await fetch("/api/v1/cluster/status",{cache:"no-store"}).then(r=>r.json());
        const h = await fetch("/api/v1/health",{cache:"no-store"}).then(r=>r.json());
        document.getElementById("localInfo").textContent = JSON.stringify(st, null, 2);
        document.getElementById("tlsInfo").textContent = JSON.stringify(h, null, 2);
      }

      async function caInit(){
        const res = await apiCall("POST", "/mgmt/security/ca/init");
        document.getElementById("ca").textContent = JSON.stringify(res, null, 2);
        await refreshStatus();
      }

      async function caShow(){
        const res = await apiCall("GET", "/mgmt/security/ca/cert");
        document.getElementById("ca").textContent = res.ca_cert_pem || JSON.stringify(res, null, 2);
      }

      async function bootstrapCreate(){
        const res = await apiCall("POST", "/mgmt/security/bootstrap/token/create");
        document.getElementById("token").textContent = res.token || JSON.stringify(res, null, 2);
      }

      async function provisionThisNode(){
        const authority = document.getElementById("authorityUrl").value.trim();
        const token = document.getElementById("bootstrapToken").value.trim();
        if (!authority) return alert("Enter Authority URL");
        if (!token) return alert("Enter Bootstrap token");

        const st = await fetch("/api/v1/cluster/status",{cache:"no-store"}).then(r=>r.json());
        const nodeId = st.node_id;
        if (!nodeId) return alert("Local node_id not found");

        const bundle = await authorityIssueBundle(authority, nodeId, token);
        const installed = await apiCall("POST", "/mgmt/security/local/install-bundle", bundle);

        document.getElementById("provisionOut").textContent =
          "Provision OK ✅\n\nNext: click 'Restart service'.\n\n" +
          JSON.stringify({ node_id: nodeId, bundle_meta: bundle.meta, installed }, null, 2);
      }

      async function restartService(){
        try{
          const res = await apiCall("POST", "/mgmt/system/restart");
          document.getElementById("provisionOut").textContent = "Restart requested.\n" + JSON.stringify(res, null, 2);
        }catch(e){
          alert("Restart failed: " + e.message);
        }
      }

      function pendingRow(key, item){
        const div = document.createElement("div");
        div.className = "pending";

        const nodeId = String(item.node_id || "");
        const peer = String(item.peer || "");

        div.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div><b>Pending</b> <span class="mono">${escapeHtml(key)}</span></div>
            ${pillHtml("PENDING","warn")}
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div>
              <div class="muted2">node_id</div>
              <div class="mono">${escapeHtml(nodeId || "(unknown)")}</div>
            </div>
            <div>
              <div class="muted2">peer</div>
              <div class="mono">${escapeHtml(peer || "(unknown)")}</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <input class="approveId" placeholder="approve as node_id" value="${escapeHtml(nodeId)}" />
            <button class="btn-primary approveBtn">Approve</button>
            <button class="btn-ghost denyBtn">Deny</button>
          </div>

          <details style="margin-top:10px;">
            <summary class="muted">Details</summary>
            <pre class="mono">${escapeHtml(JSON.stringify(item, null, 2))}</pre>
          </details>
        `;

        div.querySelector(".approveBtn").onclick = async ()=>{
          const approveId = div.querySelector(".approveId").value.trim();
          if (!approveId) return alert("Enter approve node_id");
          await apiCall("POST", "/mgmt/security/nodes/approve?node_id=" + encodeURIComponent(approveId) + "&pending_key=" + encodeURIComponent(key));
          await loadPending();
          await loadSecurityState();
          alert("Approved");
        };

        div.querySelector(".denyBtn").onclick = async ()=>{
          await apiCall("POST", "/mgmt/security/nodes/deny?pending_key=" + encodeURIComponent(key));
          await loadPending();
          alert("Denied");
        };

        return div;
      }

      async function loadPending(){
        const res = await apiCall("GET", "/mgmt/security/nodes/pending");
        const pending = res.pending || {};
        const box = document.getElementById("pendingList");
        box.innerHTML = "";

        const keys = Object.keys(pending);
        if (!keys.length){
          box.innerHTML = `<div class="muted">No pending nodes.</div>
            <div class="muted2" style="margin-top:6px;">
              If joining fails, check <a href="/events">Events</a> for <span class="mono">SECURITY_AUTH_FAILED</span>.
            </div>`;
          return;
        }
        keys.forEach(k => box.appendChild(pendingRow(k, pending[k])));
      }

      async function loadSecurityState(){
        const res = await apiCall("GET", "/mgmt/security/state");
        document.getElementById("state").textContent = JSON.stringify(res, null, 2);
      }

      async function blockNode(){
        const nodeId = document.getElementById("blockNodeId").value.trim();
        const reason = document.getElementById("blockReason").value.trim() || "revoked";
        if (!nodeId) return alert("Enter node_id");
        const res = await apiCall("POST", "/mgmt/security/nodes/block?node_id=" + encodeURIComponent(nodeId) + "&reason=" + encodeURIComponent(reason));
        document.getElementById("blockOut").textContent = JSON.stringify(res, null, 2);
        await loadSecurityState();
      }

      refreshStatus();
      loadPending();
      loadSecurityState();
    </script>
  </body>
</html>
