<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ZETA-SYNC</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <div class="wrap">
      <header class="top">
        <div>
          <div class="brand">ZETA-SYNC</div>
          <div class="sub">Cluster dashboard</div>
        </div>
        <nav class="nav">
          <a class="active" href="/">Home</a>
          <a href="/nodes">Nodes</a>
          <a href="/events">Events</a>
          <a href="/security">Security</a>
        </nav>
      </header>

      <div class="grid2">
        <div class="card">
          <h2>Cluster Health</h2>
          <div id="healthBadge" class="badge">…</div>
          <div class="kv">
            <div><span>Active / Expected</span><b id="activeExpected">-</b></div>
            <div><span>Quorum</span><b id="quorum">-</b></div>
            <div><span>Quorum Needed</span><b id="quorumNeeded">-</b></div>
            <div><span>Reference Z</span><b id="refZ">-</b></div>
          </div>

          <div class="hint" id="criteriaLine"></div>

          <details class="adv">
            <summary>Advanced / Debug</summary>
            <pre id="rawStatus"></pre>
          </details>
        </div>

        <div class="card">
          <h2>Controls</h2>
          <p class="muted">Start/Stop the local sync process on this node. Nodes view shows SYNC ON/OFF explicitly.</p>
          <div class="row">
            <button class="btn primary" onclick="clusterStart()">Start sync</button>
            <button class="btn" onclick="clusterStop()">Stop sync</button>
            <button class="btn warn" onclick="restartService()">Restart service</button>
          </div>
          <pre id="controlOut" class="small"></pre>
        </div>
      </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
      async function loadHome() {
        const st = await fetch("/api/v1/cluster/status").then(r => r.json());
        const criteria = await fetch("/api/v1/cluster/criteria").then(r => r.json());

        const c = st.cluster || {};
        setBadge("healthBadge", c.cluster_health || "…");

        document.getElementById("activeExpected").textContent = `${c.active_nodes ?? "-"} / ${c.expected_nodes ?? "-"}`;
        document.getElementById("quorum").textContent = c.quorum || "-";
        document.getElementById("quorumNeeded").textContent = c.quorum_needed ?? "-";
        document.getElementById("refZ").textContent = (c.reference_z === null || c.reference_z === undefined) ? "-" : String(c.reference_z);

        document.getElementById("criteriaLine").textContent =
          `HEALTHY when quorum met + no exclusions + stability ≥ ${criteria.healthy_stability_threshold} for ${criteria.healthy_required} ticks.`;

        document.getElementById("rawStatus").textContent = JSON.stringify(st, null, 2);
      }

      async function clusterStart(){ document.getElementById("controlOut").textContent = JSON.stringify(await apiCall("POST","/mgmt/cluster/start"),null,2);}
      async function clusterStop(){ document.getElementById("controlOut").textContent = JSON.stringify(await apiCall("POST","/mgmt/cluster/stop"),null,2);}
      async function restartService(){ document.getElementById("controlOut").textContent = JSON.stringify(await apiCall("POST","/mgmt/system/restart"),null,2);}

      loadHome();
      setInterval(loadHome, 2000);
    </script>
  </body>
</html>
