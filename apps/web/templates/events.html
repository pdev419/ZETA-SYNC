<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ZETA-SYNC Events</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <div class="wrap">
      <header class="top">
        <div>
          <div class="brand">ZETA-SYNC</div>
          <div class="sub">Events</div>
        </div>
        <nav class="nav">
          <a href="/">Home</a>
          <a href="/nodes">Nodes</a>
          <a class="active" href="/events">Events</a>
          <a href="/security">Security</a>
        </nav>
      </header>

      <div class="card">
        <div class="row spread">
          <div>
            <h2 style="margin:0">Event Log</h2>
            <div class="muted small" style="margin-top:4px">
              Ordering is by <b>node_id + sequence_id</b>. Timestamps are <b>debug-only</b>.
            </div>
          </div>

          <div class="row" style="flex-wrap: wrap; gap: 8px; justify-content: flex-end;">
            <a class="btn" href="/api/v1/export/events.csv" download>Events CSV</a>
            <a class="btn" href="/api/v1/export/events.json" download>Events JSON</a>
            <a class="btn" href="/api/v1/export/metrics.csv" download>Metrics CSV</a>
            <a class="btn" href="/api/v1/export/metrics.json" download>Metrics JSON</a>

            <button class="btn" onclick="loadEvents(true)">Refresh</button>
            <button class="btn warn" onclick="toggleAutoRefresh()">
              <span id="autoBtn">Pause</span> auto
            </button>
          </div>
        </div>

        <div id="autoPausedHint" class="muted small" style="display:none; margin-top:10px">
          Auto-refresh paused while Details is open. Close all Details to resume.
        </div>

        <div id="eventsList"></div>

        <details class="adv">
          <summary>Advanced / Debug</summary>
          <pre id="rawEvents"></pre>
        </details>
      </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
      const expanded = new Set();

      let autoOn = true;
      let timer = null;

      function toggleAutoRefresh(){
        autoOn = !autoOn;
        document.getElementById("autoBtn").textContent = autoOn ? "Pause" : "Resume";
        if(autoOn){
          schedule();
          loadEvents(false);
        } else {
          if(timer) clearInterval(timer);
          timer = null;
          document.getElementById("autoPausedHint").style.display = "none";
        }
      }

      function anyDetailsOpen(){
        return document.querySelector("details.evDetails[open]") !== null;
      }

      function schedule(){
        if(timer) return;
        timer = setInterval(() => {
          if(!autoOn) return;

          if(anyDetailsOpen()){
            document.getElementById("autoPausedHint").style.display = "block";
            return;
          } else {
            document.getElementById("autoPausedHint").style.display = "none";
          }

          loadEvents(false);
        }, 2000);
      }

      function eventKey(ev){
        return ev.event_id || (String(ev.node_id||"") + ":" + String(ev.sequence_id||""));
      }

      function fmtTs(ts){
        if(!ts) return "-";
        try{
          const d = new Date(ts * 1000);
          return d.toLocaleString();
        }catch{
          return String(ts);
        }
      }

      function renderEvent(ev){
        const k = eventKey(ev);
        const sev = String(ev.severity || "INFO").toUpperCase();
        const pillCls = (sev === "ERROR") ? "error" : (sev === "WARNING" ? "warning" : "info");

        const title = `${escapeHtml(ev.event_type || "EVENT")} · ${escapeHtml(sev)}`;
        const metaLine =
          `node=${escapeHtml(ev.node_id || "-")} · seq=${escapeHtml(ev.sequence_id ?? "-")} · debug_ts=${escapeHtml(fmtTs(ev.ts))}`;

        const raw = JSON.stringify(ev, null, 2);

        return `
          <div class="event">
            <div class="row spread">
              <div>
                <div><b>${title}</b></div>
                <div class="muted small">${metaLine}</div>
              </div>
              <div class="pill ${pillCls}">${escapeHtml(sev)}</div>
            </div>

            <details class="adv evDetails" data-key="${escapeHtml(k)}">
              <summary>Details</summary>
              <pre>${escapeHtml(raw)}</pre>
            </details>
          </div>
        `;
      }

      function captureExpanded(){
        document.querySelectorAll("details.evDetails").forEach(d => {
          const k = d.getAttribute("data-key");
          if(!k) return;
          if(d.open) expanded.add(k);
          else expanded.delete(k);
        });
      }

      function restoreExpanded(){
        document.querySelectorAll("details.evDetails").forEach(d => {
          const k = d.getAttribute("data-key");
          if(k && expanded.has(k)) d.open = true;

          d.addEventListener("toggle", () => {
            const kk = d.getAttribute("data-key");
            if(!kk) return;
            if(d.open) expanded.add(kk);
            else expanded.delete(kk);
            if(anyDetailsOpen() && autoOn){
              document.getElementById("autoPausedHint").style.display = "block";
            } else {
              document.getElementById("autoPausedHint").style.display = "none";
            }
          }, { passive: true });
        });
      }

      let lastPayloadHash = "";

      async function loadEvents(force){
        if(!force && anyDetailsOpen()){
          if(autoOn) document.getElementById("autoPausedHint").style.display = "block";
          return;
        }

        captureExpanded();

        const res = await fetch("/api/v1/cluster/events?limit=200").then(r => r.json());
        const events = res.events || [];

        // Only re-render if event identities changed (prevents unnecessary DOM churn)
        const payloadHash = JSON.stringify(events.map(e => e.event_id || (String(e.node_id||"") + ":" + String(e.sequence_id||"")))).slice(0, 2000);
        if(!force && payloadHash === lastPayloadHash){
          document.getElementById("rawEvents").textContent = JSON.stringify(res, null, 2);
          return;
        }
        lastPayloadHash = payloadHash;

        const html = events.map(renderEvent).join("");
        document.getElementById("eventsList").innerHTML = html || `<div class="muted">No events yet.</div>`;
        document.getElementById("rawEvents").textContent = JSON.stringify(res, null, 2);

        restoreExpanded();

        if(anyDetailsOpen() && autoOn){
          document.getElementById("autoPausedHint").style.display = "block";
        } else {
          document.getElementById("autoPausedHint").style.display = "none";
        }
      }

      loadEvents(true);
      schedule();
    </script>
  </body>
</html>
