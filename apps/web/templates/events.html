<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ZETA-SYNC Events</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <div class="wrap">
      <h1>Events</h1>

      <div class="nav">
        <a href="/">Home</a>
        <a href="/nodes">Nodes</a>
        <a href="/events">Events</a>
        <a href="/security">Security</a>
      </div>

      <div id="topStatus" class="row"></div>

      <div class="card">
        <div class="card-head">
          <div>
            <h2>Event log</h2>
            <div class="muted">Filter quickly. Great for join/auth debugging.</div>
          </div>
          <div class="row">
            <input id="q" placeholder="filter text (e.g. AUTH_FAILED, JOIN, OUTLIER)" style="min-width:340px;" />
            <button class="smallbtn" onclick="refresh()">Refresh</button>
            <button class="smallbtn btn-ghost" onclick="copyTextFromEl('rawOut')">Copy JSON</button>
          </div>
        </div>

        <div id="list"></div>

        <div class="divider"></div>
        <h3>Raw</h3>
        <pre id="rawOut">loadingâ€¦</pre>
      </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
      async function topStatus(){
        const box = document.getElementById("topStatus");
        try{
          const st = await fetch("/api/v1/cluster/status",{cache:"no-store"}).then(r=>r.json());
          const h = await fetch("/api/v1/health",{cache:"no-store"}).then(r=>r.json());
          box.innerHTML =
            pillHtml(h.tls_enabled ? "TLS enabled" : "TLS disabled", h.tls_enabled ? "ok" : "warn") +
            ` ${pillHtml(st.node_id || "node", "warn")}` +
            ` ${pillHtml(st.advertise_addr || "advertise", "warn")}`;
        }catch(e){
          box.innerHTML = pillHtml("status error", "bad");
        }
      }

      function sevPill(sev){
        const s = String(sev || "").toUpperCase();
        if (s === "ERROR") return pillHtml("ERROR","bad");
        if (s === "WARNING" || s === "WARN") return pillHtml("WARN","warn");
        return pillHtml("INFO","ok");
      }

      function render(events, filter){
        const q = (filter || "").trim().toLowerCase();
        const items = (events || []).filter(e=>{
          if (!q) return true;
          const txt = JSON.stringify(e).toLowerCase();
          return txt.includes(q);
        }).slice(-200).reverse();

        if (!items.length){
          document.getElementById("list").innerHTML = `<div class="muted">No matching events.</div>`;
          return;
        }

        let html = `<table><thead><tr>
          <th>seq</th><th>type</th><th>severity</th><th>details</th>
        </tr></thead><tbody>`;

        items.forEach(ev=>{
          html += `<tr>
            <td class="mono">${escapeHtml(ev.sequence_id ?? "")}</td>
            <td class="mono">${escapeHtml(ev.event_type ?? "")}</td>
            <td>${sevPill(ev.severity)}</td>
            <td class="mono">${escapeHtml(ev.reason || ev.reason_code || ev.peer || ev.detail || "")}</td>
          </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById("list").innerHTML = html;
      }

      async function refresh(){
        await topStatus();
        const res = await fetch("/api/v1/cluster/events",{cache:"no-store"}).then(r=>r.json());
        const events = res.events || [];
        const filter = document.getElementById("q").value;
        render(events, filter);
        document.getElementById("rawOut").textContent = JSON.stringify(events.slice(-200), null, 2);
      }

      document.getElementById("q").addEventListener("keydown", (e)=>{
        if (e.key === "Enter") refresh();
      });

      refresh();
    </script>
  </body>
</html>
